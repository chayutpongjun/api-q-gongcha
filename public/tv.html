<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DuckieDoze Queue Display</title>
    <style>
      :root {
        --video-width: 470px;
        --video-height: 264px;
        --qr-width: 180px;
        --qr-height: 180px;
        --color-waiting: #b3832c;
        --color-ready: #28a745;
        --color-accent: #c10130;
        --color-bg: #fff6f8;
      }

      body {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        font-family: "Kanit", sans-serif;
        color: #333;
        margin: 0;
        padding: 20px;
        overflow: hidden;
      }

      .tv-layout {
        display: flex;
        flex-direction: column;
        gap: 24px;
        max-width: 1600px;
        margin: auto;
      }

      .tv-top-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 24px;
        flex-wrap: wrap;
      }

      .tv-current-queue {
        width: 550px;
        height: 200px;
        background: #fff;
        border-radius: 20px;
        padding: 30px 20px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      .tv-current-queue h3 {
        color: #28a745;
        font-weight: 700;
        font-size: 1.6rem;
        margin: 0 0 15px 0;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .tv-current-queue-number {
        font-size: 4.5rem;
        font-weight: 900;
        color: #28a745;
        letter-spacing: 2px;
        text-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        justify-content: center;
        animation: blink 3s ease-in-out infinite;
      }

      @keyframes blink {
        0%,
        90%,
        100% {
          opacity: 1;
          transform: scale(1);
        }

        93% {
          opacity: 0.3;
          transform: scale(1.1);
        }

        96% {
          opacity: 1;
          transform: scale(1);
        }
      }

      .tv-current-queue-number .zone-initial {
        font-size: inherit;
        margin-right: 8px;
      }

      .tv-current-queue-empty {
        font-size: 1.8rem;
        color: #999;
        font-weight: 600;
      }

      .tv-video-box {
        width: var(--video-width);
        height: var(--video-height);
        background: #000;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
      }

      .tv-video {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }

      .tv-qr-box {
        flex: 1;
        min-width: 260px;
        text-align: center;
        background: #fff;
        border-radius: 20px;
        padding: 20px 10px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      }

      .tv-qr-box img {
        width: var(--qr-width);
        height: var(--qr-height);
        border-radius: 16px;
        margin-bottom: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        object-fit: contain;
      }

      .tv-qr-box h3 {
        color: var(--color-accent);
        font-weight: 700;
        font-size: 1.4rem;
        margin: 0;
      }

      .tv-divider {
        border: none;
        height: 3px;
        background: linear-gradient(90deg, #c10130, #ab772b);
        border-radius: 3px;
      }

      .tv-bottom-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 32px;
      }

      .status-page-box {
        background: #fff;
        border-radius: 24px;
        padding: 20px;
        box-shadow: 0 6px 25px rgba(0, 0, 0, 0.1);
        min-height: 420px;
        display: flex;
        flex-direction: column;
      }

      .status-title {
        text-align: center;
        font-size: 2em;
        font-weight: 800;
        margin-bottom: 12px;
      }

      .status-title.waiting {
        color: var(--color-waiting);
      }

      .status-title.ready {
        color: var(--color-ready);
      }

      .grid-3x3 {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        flex: 1;
        align-items: stretch;
      }

      .queue-card-large {
        background: #fff;
        border-radius: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 120px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        text-align: center;
        color: inherit;
      }

      .queue-card-large.waiting {
        color: var(--color-waiting);
      }

      .queue-card-large.ready {
        color: var(--color-ready);
      }

      .queue-number {
        font-size: 2.5rem;
        font-weight: 800;
        letter-spacing: 1px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: inherit;
      }

      .zone-initial {
        font-size: inherit;
        /* ‚úÖ ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡πÄ‡∏•‡∏Ç */
        font-weight: inherit;
        margin-right: 4px;
        color: inherit;
      }

      @media (max-width: 900px) {
        :root {
          --video-width: 100%;
          --video-height: auto;
          --qr-width: 150px;
          --qr-height: 150px;
        }

        .tv-top-row {
          flex-direction: column;
          align-items: center;
        }

        .tv-video-box {
          width: 100%;
          max-width: 600px;
          height: auto;
        }
      }
    </style>
  </head>

  <body>
    <div class="tv-layout">
      <div class="tv-top-row">
        <div class="tv-video-box">
          <video autoplay loop muted playsinline class="tv-video">
            <source
              src="https://thanvasu.com/CRM/161/QR/VDO.mp4"
              type="video/mp4"
            />
          </video>
        </div>
        <div class="tv-current-queue" id="currentQueue">
          <h3>üîî ‡∏Ñ‡∏¥‡∏ß‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü</h3>
          <div class="tv-current-queue-number" id="currentQueueNumber">
            <span class="tv-current-queue-empty">-</span>
          </div>
        </div>
        <div class="tv-qr-box">
          <img src="https://thanvasu.com/CRM/161/QR/CTW.jpg" alt="QR Code" />
          <h3>‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏±‡πà‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°</h3>
        </div>
      </div>

      <hr class="tv-divider" />

      <div class="tv-bottom-row">
        <div class="status-page-box">
          <h2 class="status-title waiting">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h2>
          <div class="grid-3x3" id="grid-WAITING"></div>
        </div>
        <div class="status-page-box">
          <h2 class="status-title ready">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü</h2>
          <div class="grid-3x3" id="grid-READY"></div>
        </div>
      </div>
    </div>

    <script>
      console.log("üöÄ TV.HTML SCRIPT LOADED!");

      const API_BASE = "https://api-q-DuckieDoze.thanvasupos.com/api/queue";
      const TTS_API = "https://api-q-DuckieDoze.thanvasupos.com"; // TTS API on same server
      const pathMatch = window.location.pathname.match(/\/rest\/(\w+)\/tv/);
      const restId = pathMatch ? pathMatch[1] : "1";
      let lastCalledQueue = null; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡∏¥‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÅ‡∏•‡πâ‡∏ß

      console.log("üìç Using restId:", restId);
      console.log("üîä TTS API:", TTS_API);
      console.log("üåê Current URL:", window.location.href);

      async function loadQueueData() {
        try {
          const loginRes = await fetch(`${API_BASE}/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ RestID: restId }),
          });

          if (!loginRes.ok)
            throw new Error(`Login failed (${loginRes.status})`);
          const loginData = await loginRes.json();
          const token = loginData?.data?.token || loginData?.token;
          if (!token) throw new Error("Missing token from login response");

          const res = await fetch(`${API_BASE}/execute-jwt`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              token: token,
              // ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á QueStatus ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏ó‡∏∏‡∏Å status (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô index.html)
            }),
          });

          if (!res.ok) throw new Error(`Execute-jwt failed (${res.status})`);
          const data = await res.json();
          console.log("üì¶ Full API response:", data);

          const queues = data?.data?.queueData || [];
          console.log("‚úÖ Queue loaded:", queues.length, "items");
          console.log("üìä All queues:", queues);
          console.log("üìä Sample queue:", queues[0]);

          renderFromData(queues);
        } catch (err) {
          console.error("‚ùå Load Queue Error:", err);
          document.getElementById(
            "grid-WAITING"
          ).innerHTML = `<div style="grid-column: span 3; text-align:center; color:#999;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏¥‡∏ß‡πÑ‡∏î‡πâ</div>`;
          document.getElementById(
            "grid-READY"
          ).innerHTML = `<div style="grid-column: span 3; text-align:center; color:#999;">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏¥‡∏ß‡πÑ‡∏î‡πâ</div>`;
        }
      }

      function renderFromData(queues) {
        console.log("üìä Total queues received:", queues.length);

        const sortedQueues = [...queues].sort((a, b) => {
          const numA = parseInt((a.QueName || "").replace(/\D/g, "")) || 0;
          const numB = parseInt((b.QueName || "").replace(/\D/g, "")) || 0;
          return numB - numA;
        });

        // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß Ready
        const ready = sortedQueues.filter(
          (q) => q.QueStatus?.toLowerCase() === "ready"
        );

        // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Ready (‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å status ‡∏≠‡∏∑‡πà‡∏ô‡πÜ)
        const waiting = sortedQueues.filter(
          (q) => q.QueStatus?.toLowerCase() !== "ready"
        );

        console.log("üìä Ready queues:", ready.length);
        console.log("üìä Waiting queues:", waiting.length);

        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏¥‡∏ß‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Ready ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏¥‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏ó‡∏ô)
        renderCurrentQueue(ready.length > 0 ? ready : sortedQueues.slice(0, 1));

        renderGrid(waiting, "grid-WAITING");
        renderGrid(ready, "grid-READY");
      }

      function renderCurrentQueue(readyQueues) {
        const currentQueueEl = document.getElementById("currentQueueNumber");

        if (readyQueues.length > 0) {
          const latestQueue = readyQueues[0]; // ‡πÄ‡∏≠‡∏≤‡∏Ñ‡∏¥‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß)
          const zoneInitial = latestQueue.ZoneName
            ? latestQueue.ZoneName.charAt(0).toUpperCase()
            : "";

          currentQueueEl.innerHTML = `
                    <span class="zone-initial">${zoneInitial}</span>${latestQueue.QueName}
                `;

          // ‚úÖ ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏´‡∏°‡πà
          if (lastCalledQueue !== latestQueue.QueName) {
            lastCalledQueue = latestQueue.QueName;
            callQueueVoice(latestQueue.QueName);
          }
        } else {
          currentQueueEl.innerHTML = `<span class="tv-current-queue-empty">-</span>`;
        }
      }

      // ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ñ‡∏¥‡∏ß
      async function callQueueVoice(queueNumber) {
        try {
          const queueText = `‡∏Ñ‡∏¥‡∏ß ${queueNumber}`;
          console.log(`üîä ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ${queueText}`);

          const res = await fetch(`${TTS_API}/api/callQueue`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              queueText: queueText,
              // force ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ default ‡∏à‡∏≤‡∏Å ENV (TTS_FORCE_RELOAD)
            }),
          });

          if (!res.ok) {
            console.warn(
              `‚ö†Ô∏è  TTS API Error: ${res.status} - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î TTS Server ‡∏ó‡∏µ‡πà port 10001`
            );
            return;
          }

          const data = await res.json();

          if (data.success && data.audioUrl) {
            const audioUrl = `${TTS_API}${data.audioUrl}`;
            const audio = new Audio(audioUrl);
            audio.volume = 1.0; // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ï‡πá‡∏°

            // ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á
            audio
              .play()
              .then(() => {
                console.log(
                  `‚úÖ ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ${queueText} (cached: ${!data.reloaded})`
                );
              })
              .catch((err) => {
                console.warn("‚ö†Ô∏è  ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥:", err.message);
                console.warn("üí° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á");
              });
          } else {
            console.warn("‚ö†Ô∏è  TTS API ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á audioUrl ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤");
          }
        } catch (err) {
          console.error("‚ùå ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", err.message);
          console.warn("üí° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ TTS Server ‡∏£‡∏±‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà: " + TTS_API);
        }
      }

      function renderGrid(data, id) {
        const grid = document.getElementById(id);
        const maxDisplay = 15; // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 15 ‡∏Ñ‡∏¥‡∏ß (5 ‡πÅ‡∏ñ‡∏ß x 3 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå)

        grid.innerHTML = data.length
          ? data
              .slice(0, maxDisplay)
              .map((q) => {
                const zoneInitial = q.ZoneName
                  ? q.ZoneName.charAt(0).toUpperCase()
                  : "";
                const statusClass =
                  q.QueStatus?.toLowerCase() === "ready" ? "ready" : "waiting";
                return `
                <div class="queue-card-large ${statusClass}">
                  <div class="queue-number">
                    <span class="zone-initial">${zoneInitial}</span>${q.QueName}
                  </div>
                </div>`;
              })
              .join("")
          : `<div style="grid-column: span 3; text-align:center; color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏¥‡∏ß</div>`;
      }

      // ‚úÖ Enable autoplay ‡πÇ‡∏î‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á silent audio context
      function enableAutoplay() {
        const silentAudio = new Audio();
        silentAudio.src =
          "data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAADhAC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAA4T/////////////////////////////////////////////////";
        silentAudio.volume = 0;
        silentAudio
          .play()
          .then(() => {
            console.log("‚úÖ Autoplay enabled");
          })
          .catch(() => {
            console.log("‚ö†Ô∏è  Autoplay blocked - user interaction required");
          });
      }

      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
      enableAutoplay();

      // ‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠ user interact
      document.addEventListener("click", enableAutoplay, { once: true });
      document.addEventListener("touchstart", enableAutoplay, { once: true });

      loadQueueData();
      setInterval(loadQueueData, 15000);
    </script>
  </body>
</html>
